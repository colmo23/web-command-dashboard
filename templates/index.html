<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ the_title }}</title>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="/static/css/main.css" />
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <script type="text/javascript">
        function poll(colId, intervalMs) {
            function fetch() {
                $.getJSON("ajax/get-column/" + colId, function(data) {
                    $("#column" + colId)
                        .text(data.text)
                        .closest('.terminal-window')
                        .toggleClass('terminal-error', data.is_error);
                });
            }
            fetch();
            setInterval(fetch, intervalMs);
        }

        function layoutWindows() {
            var cols = 2;
            var gap = 10;
            var winWidth = ($(window).width() - gap * (cols + 1)) / cols;
            var winHeight = $('.terminal-window').first().outerHeight();
            $('.terminal-window').each(function() {
                var col = parseInt($(this).data('col'));
                var row = parseInt($(this).data('row'));
                $(this).css({
                    width: winWidth,
                    left: gap + col * (winWidth + gap),
                    top:  gap + row * (winHeight + gap)
                });
            });
        }

        $(function() {
            layoutWindows();

            var zTop = 100;
            $('.terminal-window')
                .draggable({ handle: '.terminal-titlebar' })
                .resizable({ handles: 'all', minWidth: 250, minHeight: 150 })
                .on('mousedown', function() {
                    $(this).css('z-index', ++zTop);
                });

            {% for cmd in commands %}
            poll({{ loop.index0 }}, {{ cmd.interval * 1000 }});
            {% endfor %}
        });
    </script>
  </head>
  <body>
    {% for cmd in commands %}
    <div class="terminal-window" data-col="{{ loop.index0 % 2 }}" data-row="{{ loop.index0 // 2 }}">
      <div class="terminal-titlebar">{{ cmd.title }}</div>
      <div class="terminal-body">
        <pre id="column{{ loop.index0 }}"></pre>
      </div>
    </div>
    {% endfor %}
  </body>
</html>
